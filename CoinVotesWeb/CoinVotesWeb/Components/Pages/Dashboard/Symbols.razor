@page "/dashboard/symbols"
@using CoinVotesWeb.Components.Layout
@layout DashboardLayout
@inject IJSRuntime JS
@rendermode InteractiveServer

<PageTitle>Symbols - Dashboard</PageTitle>

<div class="card bg-dark text-light">
    <div class="card-header bg-dark border-secondary">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title text-light mb-0">Symbols Management</h3>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary" placeholder="Search symbols..." />
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search">Search</i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Symbol</th>
                        <th>Name</th>
                        <th>Code</th>
                        <th>Order No</th>
                        <th>Status</th>
                        <th>Created At</th>
                        <th>Actions</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="symbolsTableBody">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-light" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div id="pagination" class="d-flex justify-content-center mt-3">
            <!-- Pagination will be rendered here by JavaScript -->
        </div>
    </div>
    <div class="card-footer bg-dark border-secondary">
        <a href="/dashboard/symbols/add" class="btn btn-success">Add New Symbol</a>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initializeSearch");
            await JS.InvokeVoidAsync("loadSymbols");
        }
    }
} 

<script>
    // Function to fetch symbols with pagination and search
    async function fetchSymbols(page = 1, pageSize = 50, searchTerm = '') {
        try {
            const url = new URL('/api/SymbolsApi', window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('pageSize', pageSize);

            if (searchTerm) {
                url.searchParams.append('searchTerm', searchTerm);
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching symbols:', error);
            throw error;
        }
    }

    // Function to fetch a single symbol by ID
    async function fetchSymbolById(id) {
        try {
            const response = await fetch(`/detail/${id}`);
            if (!response.ok) {
                if (response.status === 404) {
                    return null;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching symbol:', error);
            throw error;
        }
    }

    // Function to render symbols in a table
    function renderSymbols(symbols, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!symbols || symbols.length === 0) {
            container.innerHTML = `
            <tr>
                <td colspan="8" class="text-center">No symbols found</td>
            </tr>
        `;
            return;
        }

        let html = '';
        symbols.forEach(symbol => {
            // Format date
            const createdAt = new Date(symbol.createdAt).toLocaleString();

            html += `
            <tr>
                <td>${symbol.id}</td>
                <td>${symbol.symbolUsdt}</td>
                <td>${symbol.name}</td>
                <td>${symbol.code}</td>
                <td>${symbol.orderNo}</td>
                <td>
                    <span class="badge ${symbol.isActive ? 'bg-success' : 'bg-danger'}">
                        ${symbol.isActive ? 'Active' : 'Inactive'}
                    </span>
                </td>
                <td>${createdAt}</td>
                <td>
                    <a href="/dashboard/symbols/edit/${symbol.id}" class="btn btn-sm btn-primary">Edit</a>
                </td>
                <td>
                    <button class="btn btn-sm ${symbol.isActive ? 'btn-danger' : 'btn-success'}" 
                            onclick="toggleSymbolStatus(${symbol.id}, ${!symbol.isActive})">
                        ${symbol.isActive ? 'Deactivate' : 'Activate'}
                    </button>
                </td>
            </tr>
        `;
        });

        container.innerHTML = html;
    }

    // Function to render pagination controls
    function renderPagination(currentPage, totalPages, containerId, onPageChange) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = `
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-dark">
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link bg-dark text-light border-secondary" href="#" aria-label="Previous" ${currentPage === 1 ? 'tabindex="-1"' : ''}>
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
    `;

        // Calculate range of page numbers to show
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        // Adjust start if we're near the end
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        // First page
        if (startPage > 1) {
            html += `
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="#" data-page="1">1</a>
            </li>
        `;
            if (startPage > 2) {
                html += `
                <li class="page-item disabled">
                    <span class="page-link bg-dark text-light border-secondary">...</span>
                </li>
            `;
            }
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link ${i === currentPage ? 'bg-primary border-primary' : 'bg-dark text-light border-secondary'}" href="#" data-page="${i}">${i}</a>
            </li>
        `;
        }

        // Last page
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `
                <li class="page-item disabled">
                    <span class="page-link bg-dark text-light border-secondary">...</span>
                </li>
            `;
            }
            html += `
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="#" data-page="${totalPages}">${totalPages}</a>
            </li>
        `;
        }

        html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link bg-dark text-light border-secondary" href="#" aria-label="Next" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    `;

        container.innerHTML = html;

        // Add event listeners
        const pageLinks = container.querySelectorAll('.page-link[data-page]');
        pageLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = parseInt(e.target.getAttribute('data-page'));
                onPageChange(page);
            });
        });

        // Previous button
        const prevButton = container.querySelector('.page-item:first-child .page-link');
        if (prevButton && currentPage > 1) {
            prevButton.addEventListener('click', (e) => {
                e.preventDefault();
                onPageChange(currentPage - 1);
            });
        }

        // Next button
        const nextButton = container.querySelector('.page-item:last-child .page-link');
        if (nextButton && currentPage < totalPages) {
            nextButton.addEventListener('click', (e) => {
                e.preventDefault();
                onPageChange(currentPage + 1);
            });
        }
    }

    // Main function to load symbols
    async function loadSymbols(page = 1, pageSize = 50, searchTerm = '') {
        try {
            const data = await fetchSymbols(page, pageSize, searchTerm);
            renderSymbols(data.items, 'symbolsTableBody');
            renderPagination(data.currentPage, data.totalPages, 'pagination', (newPage) => {
                loadSymbols(newPage, pageSize, searchTerm);
            });
        } catch (error) {
            console.error('Error loading symbols:', error);
            const container = document.getElementById('symbolsTableBody');
            if (container) {
                container.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center text-danger">
                        Error loading symbols. Please try again later.
                    </td>
                </tr>
            `;
            }
        }
    }

    // Function to initialize search functionality
    function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');

        if (!searchInput || !searchButton) return;

        // Search on button click
        searchButton.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            loadSymbols(1, 50, searchTerm);
        });

        // Search on Enter key
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = searchInput.value.trim();
                loadSymbols(1, 50, searchTerm);
            }
        });
    }

    // Function to toggle symbol status
    async function toggleSymbolStatus(id, newStatus) {
        try {
            const response = await fetch(`/api/SymbolsApi/${id}/toggle-status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ isActive: newStatus })
            });

            if (!response.ok) {
                throw new Error('Failed to update symbol status');
            }

            // Reload the symbols list to reflect the change
            loadSymbols();
        } catch (error) {
            console.error('Error updating symbol status:', error);
            alert('Failed to update symbol status. Please try again.');
        }
    }

    // Make the loadSymbols function available globally
    window.loadSymbols = loadSymbols;
    window.initializeSearch = initializeSearch;
    window.toggleSymbolStatus = toggleSymbolStatus;
    
</script>