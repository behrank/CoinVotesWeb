@page "/dashboard/users"
@layout DashboardLayout
@inject IJSRuntime JS
@using CoinVotesWeb.Components.Layout
@rendermode InteractiveServer

<PageTitle>Users - Dashboard</PageTitle>

<div class="card bg-dark text-light">
    <div class="card-header bg-dark border-secondary">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title text-light mb-0">Users</h3>
            <div class="input-group" style="width: 300px;">
                <input type="text" id="searchInput" class="form-control bg-dark text-light border-secondary" placeholder="Search users..." />
                <button class="btn btn-outline-secondary" type="button" id="searchButton">
                    <i class="bi bi-search">Search</i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Create Date</th>
                    <th>Device Type</th>
                    <th> </th>
                </tr>
                </thead>
                <tbody id="usersTableBody">
                <tr>
                    <td colspan="4" class="text-center">
                        <div class="spinner-border text-light" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
        
        <div id="pagination" class="d-flex justify-content-center mt-3">
            <!-- Pagination will be rendered here by JavaScript -->
        </div>
    </div>
</div>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JS.InvokeVoidAsync("initializeSearch");
            await JS.InvokeVoidAsync("loadUsers");
        }
    }
}

<script>
    const defaultPageSize = 50;
    // Function to fetch users with pagination and search
    async function fetchUsers(page = 1, pageSize, searchTerm = '') {
        try {
            const url = new URL('/api/UsersApi', window.location.origin);
            url.searchParams.append('page', page);
            url.searchParams.append('pageSize', pageSize);

            if (searchTerm) {
                url.searchParams.append('searchTerm', searchTerm);
            }

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching users:', error);
            throw error;
        }
    }

    // Function to fetch a single user by ID
    async function fetchUserById(id) {
        try {
            const response = await fetch(`/api/UsersApi/GetUser/${id}`);
            if (!response.ok) {
                if (response.status === 404) {
                    return null;
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Error fetching user:', error);
            throw error;
        }
    }

    // Function to render users in a table
    function renderUsers(users, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (!users || users.length === 0) {
            container.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center">No users found</td>
                </tr>
            `;
            return;
        }

        let html = '';
        users.forEach(user => {
            // Format date
            let formattedDate = 'N/A';
            if (user.createdAt) {
                try {
                    const date = new Date(user.createdAt);
                    if (!isNaN(date.getTime())) {
                        formattedDate = date.toLocaleString();
                    }
                } catch (error) {
                    console.error('Error parsing date:', error);
                }
            }

            html += `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.email}</td>
                    <td>${user.device}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <a href="/dashboard/users/details/${user.id}" class="btn btn-sm btn-info">Details</a>
                    </td>
                </tr>
            `;
        });

        container.innerHTML = html;
    }

    // Function to render pagination controls
    function renderPagination(currentPage, totalPages, containerId, onPageChange) {
        const container = document.getElementById(containerId);
        if (!container) return;

        if (totalPages <= 1) {
            container.innerHTML = '';
            return;
        }

        let html = `
        <nav aria-label="Page navigation">
            <ul class="pagination pagination-dark">
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link bg-dark text-light border-secondary" href="#" aria-label="Previous" ${currentPage === 1 ? 'tabindex="-1"' : ''}>
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
    `;

        // Calculate range of page numbers to show
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);

        // Adjust start if we're near the end
        if (endPage - startPage < 4) {
            startPage = Math.max(1, endPage - 4);
        }

        // First page
        if (startPage > 1) {
            html += `
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="#" data-page="1">1</a>
            </li>
        `;
            if (startPage > 2) {
                html += `
                <li class="page-item disabled">
                    <span class="page-link bg-dark text-light border-secondary">...</span>
                </li>
            `;
            }
        }

        // Page numbers
        for (let i = startPage; i <= endPage; i++) {
            html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link ${i === currentPage ? 'bg-primary border-primary' : 'bg-dark text-light border-secondary'}" href="#" data-page="${i}">${i}</a>
            </li>
        `;
        }

        // Last page
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                html += `
                <li class="page-item disabled">
                    <span class="page-link bg-dark text-light border-secondary">...</span>
                </li>
            `;
            }
            html += `
            <li class="page-item">
                <a class="page-link bg-dark text-light border-secondary" href="#" data-page="${totalPages}">${totalPages}</a>
            </li>
        `;
        }

        html += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link bg-dark text-light border-secondary" href="#" aria-label="Next" ${currentPage === totalPages ? 'tabindex="-1"' : ''}>
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            </ul>
        </nav>
    `;

        container.innerHTML = html;

        // Add event listeners
        const pageLinks = container.querySelectorAll('.page-link[data-page]');
        pageLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const page = parseInt(e.target.getAttribute('data-page'));
                onPageChange(page);
            });
        });

        // Previous button
        const prevButton = container.querySelector('.page-item:first-child .page-link');
        if (prevButton && currentPage > 1) {
            prevButton.addEventListener('click', (e) => {
                e.preventDefault();
                onPageChange(currentPage - 1);
            });
        }

        // Next button
        const nextButton = container.querySelector('.page-item:last-child .page-link');
        if (nextButton && currentPage < totalPages) {
            nextButton.addEventListener('click', (e) => {
                e.preventDefault();
                onPageChange(currentPage + 1);
            });
        }
    }

    // Main function to load users
    async function loadUsers(page = 1, searchTerm = '') {
        try {
            const data = await fetchUsers(page, defaultPageSize, searchTerm);
            renderUsers(data.items, 'usersTableBody');
            renderPagination(data.currentPage, data.totalPages, 'pagination', (newPage) => {
                loadUsers(newPage, searchTerm);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            const container = document.getElementById('usersTableBody');
            if (container) {
                container.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center text-danger">
                        Error loading users. Please try again later.
                    </td>
                </tr>
            `;
            }
        }
    }

    // Function to initialize search functionality
    function initializeSearch() {
        const searchInput = document.getElementById('searchInput');
        const searchButton = document.getElementById('searchButton');

        if (!searchInput || !searchButton) return;

        // Search on button click
        searchButton.addEventListener('click', () => {
            const searchTerm = searchInput.value.trim();
            loadUsers(1, searchTerm);
        });

        // Search on Enter key
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const searchTerm = searchInput.value.trim();
                loadUsers(1, searchTerm);
            }
        });
    }

    // Make the loadUsers function available globally
    window.loadUsers = loadUsers;

</script>